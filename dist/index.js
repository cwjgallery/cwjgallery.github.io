"use strict";var ImgLoader=function(){function t(t){this.setsrc(t),this.cache=new Map}return t.prototype.loadimg=function(l){var d=this;return new Promise(function(i,t){var o=new Image;o.src="gallery/"+l,o.onload=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=document.createElement("canvas");r.width=o.width,r.height=o.height,r.getContext("2d").drawImage(o,0,0,o.width,o.height);var n=o.src.substring(o.src.lastIndexOf(".")+1).toLowerCase(),a=r.toDataURL("image/"+n);d.setImg(l,a),i()},o.onerror=t})},t.prototype.readImg=function(t){if(this.cache.has(t)){var e=new Image;return e.src=this.cache.get(t),e}return null},t.prototype.setImg=function(t,e){this.cache.has(t)||this.cache.set(t,e)},t.prototype.setsrc=function(t){this.src=t.map(function(t){return t.thumb||(t.thumb=t.url),t})},t.prototype.loadThumb=function(){var e=this;return Promise.all(this.src.map(function(t){return e.loadimg(t.thumb)}))},t.prototype.loadFull=function(){var e=this;return Promise.all(this.src.map(function(t){return e.loadimg(t.url)}))},t.prototype.getImg=function(t){return this.readImg(t)},t}();function __values(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function __read(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,a,i=r.call(t),o=[];try{for(;(void 0===e||0<e--)&&!(n=i.next()).done;)o.push(n.value)}catch(t){a={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(a)throw a.error}}return o}function __spread(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(__read(arguments[e]));return t}var formatter={formatDate:function(t){var e=new Date(t);return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()}},h=function(t,e,r){var n,a,i=document.createElement(t);if(e)try{for(var o=__values(Object.entries(e)),l=o.next();!l.done;l=o.next()){var d=__read(l.value,2),h=d[0],c=d[1];i.setAttribute(h,c)}}catch(t){n={error:t}}finally{try{l&&!l.done&&(a=o.return)&&a.call(o)}finally{if(n)throw n.error}}return r&&(Array.isArray(r)||(r=[r]),r.forEach(function(t){"string"==typeof t?i.innerText=t:i.appendChild(t)})),i},appendFirst=function(t,e){e.children.length?e.insertBefore(t,e.children[0]):e.append(t)},setStyle=function(e,t){Object.entries(t).forEach(function(t){e.style[t[0]]=t[1]})},container=document.body,header=h("div",{class:"header"},h("div",{class:"title"},"wwj gallery"));container.append(header);var thumbwrap=h("div",{class:"thumb-wrap"});container.appendChild(thumbwrap);var detailwrap=h("div",{class:"detail-wrap"});detailwrap.addEventListener("click",function(){return setStyle(detailwrap,{display:"none"})}),setStyle(detailwrap,{display:"none"}),container.appendChild(detailwrap);var renderthumb=function(t,a){thumbwrap.innerHTML="";var e=Math.floor(thumbwrap.offsetWidth/300),i=Array.from({length:e}).map(function(){return 0});thumbwrap.append.apply(thumbwrap,__spread(Array.from({length:e}).map(function(){return h("div",{class:"waterfall"})}))),t.forEach(function(e){var t=a.getImg(e.thumb);t.className="thumbimg",t.addEventListener("click",function(t){return openFull(e.url,a,t)});var r=h("div",{class:"thumb"},[h("div",{class:"desc"},e.desc),h("div",{class:"date"},formatter.formatDate(e.date))]);appendFirst(t,r);var n=i.findIndex(function(t){return t===Math.min.apply(Math,__spread(i))});thumbwrap.children[n].append(r),i[n]+=r.offsetHeight}),render3d()},render3d=function(){for(var t=0;t<thumbwrap.children.length;t++)for(var e=thumbwrap.children[t],r=0;r<e.children.length;r++){var n=e.children[r],a=n.getClientRects()[0],i=a.top,o=a.bottom;a.left,a.right,a.width,a.height;if(!(o<0)){if(i>container.offsetHeight)break;var l=i+o/2-container.offsetHeight/2;container.offsetHeight;setStyle(n,{transform:"translate("+l/-5+"px)\n                rotate3d(1, 1, 0, 10deg)"})}}},openFull=function(t,e,r){setStyle(detailwrap,{display:""}),detailwrap.innerHTML="";var n=r.screenX,a=r.screenY,i=e.getImg(t),o=i.width,l=i.height;setStyle(i,{transition:".2s",width:"0px",height:"0px",position:"absolute",left:n+"px",top:a+"px"}),detailwrap.append(i);var d=o/l>detailwrap.offsetWidth/detailwrap.offsetHeight?{width:"100%",height:"auto",top:(detailwrap.offsetHeight-l*(detailwrap.offsetWidth/o))/2+"px",left:0}:{width:"auto",height:"100%",top:0,left:(detailwrap.offsetWidth-o*(detailwrap.offsetHeight/l))/2+"px"};setTimeout(function(){setStyle(i,d)})},renderFull=function(){};document.addEventListener("scroll",render3d);var galleryLoader=new ImgLoader(window.__GALLERY_LIST__),list=galleryLoader.src;galleryLoader.loadThumb().then(function(){return renderthumb(list,galleryLoader),galleryLoader.loadFull()}).then(renderFull).catch(function(){console.log("图片加载失败")}),window.addEventListener("resize",function(){return renderthumb(list,galleryLoader)});
